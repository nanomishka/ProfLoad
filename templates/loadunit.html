{% extends "base.html" %}

{% block main %}

<h4>Нагрузочная единица</h4>

<table class="table table-hover">
    <tr>
        <th>№</th>
        <th>Предмет</th>
        <th>Форма сдачи</th>
        <th>Группы</th>
        <th>Тип Нагрузки</th>
        <th>Часы</th>
        <th></th>
    </tr>
    {% for loadUnit in loadUnits %}
    <tr> 
        <td>{{forloop.counter}}</td>
        <td>{{loadUnit.subject.name}}</td>
        <td>{{loadUnit.formPass.name}}</td>
        <td>{{loadUnit.caf.name}}-{{loadUnit.sem}}x{% if loadUnit.grade == "b"%}Б
            {% elif loadUnit.grade == "m"%}М
            {% endif %}</td>
        <td>{{loadUnit.typeLoad.name}}</td>
        <td>{{loadUnit.hours}}
                <a href="#split" role="button" data-toggle="modal" onclick="clear_form({{loadUnit.id}}, {{loadUnit.hours}});"><i class="icon-split"></i></a>
        </td>
        <td>
            <a href="?remove={{loadUnit.id}}"><i class="icon-trash"></i></a>
        </td>
    </tr>
    {% endfor %}
</table>

<!-- Button for FORM CREATE -->
<a href="#myModal" role="button" class="btn btn-primary" data-toggle="modal">Добавить нагрузочную единицу</a>
<!-- FORM CREATE -->
<div id="myModal" class="modal hide fade" tabindex="-1" 
    role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="myModalLabel">Добавление нагрузочной единицы</h3>
    </div>

    <form class="form-horizontal nomargin" action="" method="post">
        <div class="modal-body nomargin">
        
            <div class="form-group">
                <label for="subject" class="col-sm-2 control-label">Предмет</label>
                <select class="span2" name="subject" required>
                    <option value="" selected>Выбрать</option>
                    {% for subject in subjects %}
                        <option value="{{ subject.name }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="formPass" class="col-sm-2 control-label">Форма сдачи</label>
                <select class="span2" name="formPass" required>
                    <option value="" selected>Выбрать</option>
                    {% for formPass in formPasss %}
                        <option value="{{ formPass.name }}">{{ formPass.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="caf" class="col-sm-2 control-label">Кафедра</label>
                <select class="span2" name="caf" required>
                    <option value="" selected>Выбрать</option>
                    {% for caf in cafs %}
                        <option value="{{ caf.name }}">{{ caf.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="sem" class="col-sm-2 control-label">Семестр</label>
                <select class="span2" name="sem" required>
                    <option value="" selected>Выбрать</option>
                    {% for sem in semesters %}
                        <option value="{{ sem.sem }}_{{ sem.grade }}" data-caf="{{ sem.caf }}" class="select_hidden">{{ sem.sem }}{{group.caf.name}}{{group.sem}}{{group.number}}{% if sem.grade == "b"%}Б{% elif sem.grade == "m"%}М{% endif %}     ({{ sem.count }})</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label muted">Тип нагрузки</label>
                <label class="col-sm-2 pad5 form-control muted" >Количество часов</label>
            </div>

            {% for typeLoad in typeLoads %}
            <div class="form-group">
                    <label for="load{{ typeLoad.id }}" class="col-sm-2 control-label">{{ typeLoad.name }}</label>
                    <input type="number" class="form-control input_short" id="load{{ typeLoad.id }}" 
                        name="load{{ typeLoad.id }}" value="0">
            </div>
            {% endfor %}
        </div>

        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">Закрыть</button>
            <button type="submit" class="btn btn-primary">Добавить нагрузочную единицу</button>
        </div>

    </form>
</div>

<form action="" method="post">
    <div id="split" class="modal hide fade" tabindex="-1" 
        role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="myModalLabel">Разделение нагрузки</h3>
        </div>

        <div class="form-horizontal nomargin">
            <div class="modal-body">

                <div class="form-group">
                        <label for="number" class="col-sm-2 control-label">Количество частей</label>
                        <input type="number" class="form-control input_short" min="1" max="5" id="number" name="number" value=1 required>
                </div>

                <div class="parts">
                </div>

            </div>
        </div>

        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">Закрыть</button>
            <button type="submit" class="btn btn-primary">Разделить нагрузку</button>
        </div>

    </div>
</form>

<script>

    $("select[name=caf]").change(function() {
        $("select[name=sem] option[data-caf!="+$(this).val()+"]").addClass("select_hidden");
        $("select[name=sem] option[data-caf="+$(this).val()+"]").removeClass();
    })

    var hours = 0;

    $("input[name=number]").change(function() { 
        count = $(this).val();
        inputs = $(".parts input[type=number]").size();
        if (count > inputs) 
            for (i=inputs; i < count; i++) {
                var $in2 = $("<input type='number' min=0 class='form-control input_number input_number_2' id='number' name='hours"+i+"' value=0 required/>");
                $(".parts").append($in2);
                $('input[name=hours'+i+']').change(function() {
                    check(parseInt($(this).attr('name').replace('hours','')));
                });
            } else {
                for (i=count; i < inputs; i++) {
                    $(".parts input[type=number]")[i].remove();
                }
                check(0);
        }
    });

    function check(index) {
        list = $(".parts input[type=number]");
        sum = 0;
        last = hours;
        for (i=0; i < list.size(); i++) {
            if ( i>index) {
                list[i].value = last;
            }
            last -= parseInt(list[i].value);
        }
    }

    function clear_form(spread, count) { 
        hours=count;
        $("input[name=number]").val(2);
        $(".parts").empty();
        $(".parts").append($("<input type='hidden' name='idLoad' value='"+spread+"'/>"));
            $(".parts").append($in2);
        for (i=0; i < 2; i++) {
            var $in2 = $("<input type='number' min=0 class='form-control input_number input_number_2' id='number' name='hours"+i+"' value=0 required/>");
            $(".parts").append($in2);
            $('input[name=hours'+i+']').change(function() {
                check(parseInt($(this).attr('name').replace('hours','')));
            });
        }
        check(-1);
    }

</script>
{% endblock %}